<?php

use Drupal\Core\Cache\Cache;

/**
 * Implements hook_basic_entity_view().
 */

function hook_basic_entity_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, mixed $view_mode) {
  // Check if the entity is a node.
  if ($entity->getEntityTypeId() === 'node') {
    $session = \Drupal::request()->getSession();
    $nid = $entity->id();
    $build['#cache'] = [
      '#cache' => [
        'tags' => ['node:' . $nid,],
      ],
    ];
    $count = $session->get('node_view_count_' . $nid, 0);
    $count++;
    Cache::invalidateTags(['node:' . $nid]);
    $session->set('node_view_count_' . $nid, $count);
    \Drupal::messenger()->addStatus(t('This node has been viewed @count times in this session.', ['@count' => $count]));
  }
}
